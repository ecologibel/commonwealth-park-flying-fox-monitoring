---
title: "Hanging in there: the highs and lows of a flying-fox camp in a novel landscape"
author: "Wilson B A & Rapley S"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_document:
    toc: true
    number_sections: true
    top_depth: 3
    toc_float:
      collapsed: true
    theme: cerulean
    highlight: pygments
    self_contained: true
editor_options:
  chunk_output_type: console
knit: "(function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_file = file.path(dirname(inputFile), 'tutorial.html')) })"
---

# **Background**

This [R project](https://support.posit.co/hc/en-us/articles/200526207-Using-RStudio-Projects) presents the datasets and workflows used in the '*Hanging in there: the highs and lows of a flying-fox camp in a novel landscape*' project. For information, visit the [GitHub repo](https://github.com/ecologibel/commonwealth-park-flying-fox-monitoring). 

# **Setup**

## Set global options

```{r global-options, echo = FALSE}
# Set default knitting options 
knitr::opts_chunk$set(
  echo = TRUE, 
  eval = TRUE
)

# Set chunk behaviours (e.g., chunks with 'draft = TRUE' will not run)
knit <- list(
  # For one-off installation chunks (do not run)
  init_once = list(eval = FALSE),
  # For setup chunks (hide chunk and output)
  setup     = list(echo = FALSE, message = FALSE, warning = FALSE), 
  # For setup function chunks (show chunk but not output)
  echo_only = list(echo = TRUE, message = FALSE, warning = FALSE),
  # For function chunks (hide chunk but show output)
  fun       = list(echo = FALSE), 
  # For draft chunks (do not run)
  draft     = list(eval = FALSE),
  # For dynamic summary chunks (hide chunk but show inline results)
  ds        = list(echo = FALSE, results = 'asis'),
  # For plot chunks Plotting chunk (always run)
  plot      = list(eval = TRUE),
  # Set size defaults for printed figures
  fig       = list(fig.height = 10, fig.width = 15),
  # For ggsave chunks (always run) 
  ggsave    = list(eval = TRUE)
)

# Define hook functions based on knit list
knitr::opts_hooks$set(
  draft = function(options) {
    if (isTRUE(options$draft)) {
      options$eval <- FALSE
    }
    options
  }
)
```

## Initialise project

To initialise your project, load the function below then run `run_setup()`. 

Depending on how many packages need installing, it may take a while. Feel free to have a look through `setup.Rmd` so you're familiar with the setup. 

```{r, setup = TRUE}
# Define setup function
run_setup <- function(path = "setup.Rmd", total = 3) {
  if (!requireNamespace("cli", quietly = TRUE)) {
    install.packages("cli")}
  library(cli)

  # Progress bar
  cli_progress_bar("Initialising setup", total = total)

  if (is.null(knitr::opts_knit$get("output.dir"))) {
    knitr::opts_knit$set(output.dir = getwd())}
  cli_progress_update(set = 2)

  if (isTRUE(getOption("knitr.in.progress"))) {
    # During knitting → include setup.Rmd inline 
    # (respects chunk options + text)
    invisible(knitr::knit_child(
      path, 
      quiet = TRUE, 
      envir = knitr::knit_global()))
  } else {
    
    # Interactive use → inline helper to extract & eval code blocks
    extract_r_code <- function(file) {
      lines  <- readLines(file, warn = FALSE)
      starts <- grep("^```\\{r", lines)
      ends   <- grep("^```\\s*$", lines)
      blocks <- mapply(
        function(s, e) {
          header <- lines[s]
          code <- lines[(s + 1):(e - 1)]
          # Skip if eval = FALSE
          if (grepl("eval\\s* = \\s*FALSE", header)) return(NULL)
          code
        },
        starts, 
        ends,
        SIMPLIFY = FALSE
      )
      paste(unlist(blocks), collapse = "\n")
    }

    code <- extract_r_code(path)
    eval(parse(text = code), envir = globalenv())
  }

  cli_progress_update(set = 3)
  cli_progress_done()
  cli_alert_success("Setup successful!")
}
```

```{r}
# Run setup 
run_setup()
```

## Load project-specific packages

This script installs and loads *project-specific* packages (*commonly used* packages are loaded in `setup.Rmd`). 

```{r, results = 'hide', warning = FALSE, message = FALSE}
# Install and load project-related packages
pacman::p_load(
  # Data wrangling
  grid, hms, naniar, reshape2 
) 
```

## Define resources

This chunk tabulates the abbreviations used in our workflows.  

```{r, draft = TRUE}
# Read in abbrevations list and print it as a clean table
(def <- print_clean_table(raw_data, sheet = "definitions"))
```

### Constants

```{r}
# Define dates for current reporting period
START            <- "2024-12-01"
END              <- "2025-11-30"
REPORTING_PERIOD <- 2025

# Define whether LRFFs were recorded in the last reporting period
LRFFS_RECORDED   <- FALSE
```

```{r}
# Define constant ggplot arguments
map_height  <- 6
map_width   <- 6
plot_height <- 6 
plot_width  <- 9
dpi         <- 300
```

```{r}
# Define columns in `monitoring` sheet
monitoring_cols <- c(
  "location", 
  "survey", 
  "date", 
  "start", 
  "finish", 
  "hours", 
  "ghff", 
  "lrff", 
  "trees_occupied", 
  "include"
)
```

### Functions

```{r}
# Define function to convert Excel times to hms
to_hms <- function(x) {
  # Leave hms values unchanged
  if (inherits(x, "hms")) {
    return(x)
  }

  # Extract time-of-day from POSIXct/POSIXlt datetimes
  if (inherits(x, "POSIXt")) {
    return(hms::as_hms(as.numeric(x) %% 86400))
  }

  # Convert difftime durations to seconds
  if (inherits(x, "difftime")) {
    return(hms::as_hms(as.numeric(x, units = "secs")))
  }

  # Handle numeric Excel times by keeping the fractional day
  if (is.numeric(x)) {
    frac_day <- x %% 1
    return(hms::as_hms(frac_day * 86400))
  }

  # Parse character times and treat blanks as missing
  x_chr <- na_if(trimws(as.character(x)), "")
  hms::as_hms(readr::parse_time(x_chr, format = "%H:%M"))
}
```

# **Data preparation**

We entered the FF survey data in a [Microsoft Access](https://www.microsoft.com/en-au/microsoft-365/access) database. To put this into a form that we can use in this R markdown: 

  1. Copy the `Survey` and `Tree` tables from the database into their respective sheets in `input/raw data.xlsx`. 
  2. Copy the rows from the last reporting period (Dec 1–Nov 30) in the `Schedule` sheet of the `ABS flying-fox monitoring` Google spreadsheet (requires specific access) to the bottom of the `monitoring` sheet.

# **Plots**

## Abundance and trees occupied

First, we generate a **(a)** raw line graph and a **(b)** smoothed line graph by month, with two y-axes (Fig 3a):

  1. **Primary axis:** GHFF and LRFF abundance over time (0–10,000)
      - *Note: no LRFFs were recorded during the 2025 reporting period.*
  2. **Secondary axis:** Number of trees occupied by FFs (0–160)

```{r, results = 'hide', warning = FALSE, message = FALSE}
# Read in data
data <- read_excel(raw_data, sheet = "monitoring") %>% 
  # Standardise column names to lowercase with underscores
  clean_names() %>%
  # Select relevant columns
  select(all_of(monitoring_cols)) %>%
  # Convert columns
  mutate(
    # Convert dates and times
    across(c(start, finish, hours), to_hms), 
    ghff = as.character(ghff), 
    lrff = as.character(lrff)
  ) %>%
  
  # Filter to relevant site
  filter(
    include  == "Yes", 
    location == "Commonwealth Park"
  ) %>%
  
  # Pivot df to long format
  pivot_longer(
    cols      = c("ghff", "lrff"), 
    names_to  = "species", 
    values_to = "count"
  ) %>%
  
  # Convert count values
  mutate(count = if_else(count == "800-1000", "900", count)) %>%
  mutate(count = if_else(count == "200-250",  "225", count)) %>% 
  
  # Replace ranges with mean
  mutate(
    count          = as.numeric(count),
    trees_occupied = as.numeric(trees_occupied),
    date           = as.Date(date, format = c("%d/%m/%Y"))
  ) %>%
  mutate(year = year(date))

# Subset to current reporting period
data_current <- data %>%
  filter(date > START & date < END) %>%
  # Include LRFFs if LRFFS_RECORDED = TRUE 
  filter(LRFFS_RECORDED | species != "lrff")

# Export df to a new sheet in the running workbook
workbook <- export_sheet(data, sheet = "data")
```

**Raw line graph**

```{r}
# Line plot raw abundance
(abun_raw <- ggplot(data_current) +
  
  geom_line(
    mapping   = aes(date, count, col = species), 
    linewidth = 0.6
  ) +
  
  geom_line(
    mapping   = aes(
      date, 
      trees_occupied*50, 
      col     = 'chartreuse4'), 
    linewidth = 0.6
  ) +
  
  labs(
    x = "Month", 
    y = "Flying-foxes recorded"
  ) + 
  
  scale_color_manual(
    name   = '', 
    values = c("#CACBE8","#1F2148","#7B7FC7"), 
    labels = c("Trees occupied", "Grey-headed flying-fox")
  ) +
  scale_x_date(
    date_breaks = "1 month", 
    date_labels = "%b"
  ) +
  scale_y_continuous(
    breaks   = seq(0, 10000, 2000), 
    sec.axis = sec_axis(~ ./50, name = "Trees occupied")
  ) + 
  
  theme_minimal() + 
  
  # 
  theme(
    axis.line        = element_line(colour = "darkgrey"), 
    axis.text.x      = element_text(
      angle  = 0, 
      vjust  = 1, 
      hjust  = 0, 
      colour = "black"
    ),
    axis.text.y      = element_text(
      angle  = 0, 
      vjust  = 0.5, 
      colour = "black"
    ), 
    axis.title.x     = element_text(vjust = -2), 
    axis.title.y     = element_text(
      vjust  = 5, 
      margin = margin(r = 5)
    ),
    legend.position  = "bottom", # "c(x, y)" or "none"
    legend.title     = element_blank(), 
    panel.background = element_rect(
      fill   = "white", 
      colour = NA
    ), 
    panel.grid       = element_blank(),
    plot.margin      = margin(t = 0.2, r = 0.5, b = 0, l = 0.2, "cm"), 
    
    # Add a plot label
    plot.tag         = element_text(
      size  = 12, 
      face  = "bold", 
      vjust = -5
    ), 
    strip.background = element_blank()
  )
)
```

**Smoothed line graph**

```{r}
# Smooth plot abundance
(abun_smooth <- ggplot(data_current) +
  geom_smooth(
    mapping   = aes(
      col     = species, 
      count, 
      date, 
      fill    = species
    ), 
    linewidth = 0.6
  ) +
  
  geom_smooth(
    mapping   = aes(
      col     = 'chartreuse4', 
      date, 
      fill    = 'chartreuse4', 
      trees_occupied * 50
    ), 
    linewidth = 0.6
  ) + 
  
  labs(
    x = "Month", 
    y = "Flying-foxes recorded"
  )

  scale_color_manual(
    labels = c("Trees occupied", "Grey-headed flying-fox"), 
    name   = '', 
    values = c("#CACBE8","#1F2148","#7B7FC7")
  ) +
    
  scale_fill_manual(
    labels = c("Trees occupied", "Grey-headed flying-fox"), 
    name   = '', 
    values = c("#CACBE8","#1F2148","#7B7FC7")
  ) + 
    
  scale_x_date(
    date_breaks = "1 month", 
    date_labels = "%b"
  ) +
    
  scale_y_continuous(
    breaks   = seq(0, 10000, 2000), 
    sec.axis = sec_axis(~ ./50, name = "Trees occupied")
  )
  
  theme_minimal() +
  
  theme(
    axis.line        = element_line(colour = "darkgrey"), 
    axis.text.x      = element_text(
      angle = 0, 
      colour = "black", 
      hjust = 0, 
      vjust = 1
    ),
    axis.text.y      = element_text(
      angle = 0, 
      colour = "black", 
      vjust = 0.5
    ),
    axis.title.x     = element_text(vjust = -2), 
    axis.title.y     = element_text(vjust = 5, margin = margin(r = 5)),
    legend.text      = element_text(size  = 8),
    legend.position  = c(0.75, 0.25), # "c(x, y)" or "none"
    legend.title     = element_blank(),
    panel.background = element_rect(fill = "white", colour = NA), 
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(), 
    panel.border     = element_blank(),
    
    # Add space to the left for combined plot
    plot.margin      = margin(t = 0.2, r = 0.1, b = 0, l = 0.5, "cm"), 
    
    # Add a plot label
    plot.tag         = element_text(size = 12, face = "bold", vjust = -5), 
    strip.background = element_blank()
  )
)

# Display the plot
print(abun_smooth)
```

```{r}
# Create a light grey dividing line as an empty plot
divider <- ggplot() +
  
  # Add the dividing line
  geom_vline(
    color      = "black", 
    size       = 0.5, 
    xintercept = 0
  ) +
  
  # Extend the line infinitely in the y-direction
  ylim(-Inf, Inf) +
  theme_void()

# Combine plots into a single figure
abun_current <- ggarrange(
  abun_raw, 
  divider, 
  abun_smooth, 
  ncol    = 3, 
  nrow    = 1, 
  labels  = c("a", "", "b"), 
  label.x = 0.8, 
  label.y = 0.98, 
  widths  = c(1, 0.02, 1), 
  align   = "h"
)

# Display plot
print(abun_current)
```

```{r, eval = FALSE, include = FALSE}
# Export plot as a jpeg file
ggsave(
  filename = "output/fig 3a abundance.jpeg",
  plot     = abun_current, 
  height   = 100, 
  width    = 250, 
  units    = "mm", 
  dpi      = 800
)
```

## Mean abundance per month

Bar graph with month on the x-axis and FF abundance on the y-axis, showing the following as separate bars with standard error bars (Fig 3b): 

  1. Mean (±SE) FFs recorded (primary axis ranging 0–6,000)
  2. Mean (±SE) trees occupied (secondary axis ranging 0–140)
  3. Mean (±SE) ratio of FFs-to-trees (secondary axis ranging 0–140)

For the purposes of plotting the mean number of trees occupied and tree-by-bat ratio on a secondary axis, we multiplied these values by 40, then reversed this before plotting.

```{r}
# Read in the data
data_current <- read_excel(raw_data, sheet = "monitoring") %>% 
  clean_names() %>% 
  
  filter(
    include == "Yes", 
    location == "Commonwealth Park"
  ) %>% 
  
  mutate(year = year(date)) %>% 
  subset(date > START & date < END) %>% 
  
  mutate(
    month      = lubridate::month(
      date, 
      label    = TRUE, 
      abbr     = TRUE
    ), 
    ghff       = as.numeric(ghff), 
    lrff       = as.numeric(lrff), 
    bats_total = ghff + lrff, 
    ratio      = as.numeric(bats_total / trees_occupied)
  ) %>% 
  
  mutate(ratio = ifelse(ratio == "NaN", 0, ratio)) 

# Calculate mean statistics
data_current_means <- data_current %>% 
  group_by(month) %>% 
  
  summarise(
    count_mean = mean(bats_total),
    ratio_mean = 40 * mean(ratio),
    trees_mean = 40 * mean(trees_occupied)
  ) %>%
  
  pivot_longer(
    2:4, 
    names_to = "type", 
    values_to = "mean"
  )

# Calculate standard error (SE) statistics
data_current_se <- data_current %>% 
  group_by(month) %>% 
  
  summarise(
    count_se = sd(bats_total) / sqrt(length(bats_total)),
    ratio_se = 40 * sd(ratio) / sqrt(length(ratio)),
    trees_se = 40 * sd(trees_occupied) / sqrt(length(trees_occupied))) %>%
  
  pivot_longer(
    2:4, 
    names_to  = "type", 
    values_to = "se"
  )

# Combine means and SE
data_current_stats <- cbind(
  data_current_means, 
  data_current_se
)

colnames(data_current_stats) <- make.unique(names(data_current_stats))
```

So each month plots regardless of whether FFs were detected, manually generate rows for these months.

```{r}
# Manually create rows for months where bats were not detected
jul <- data.frame(
  "Jul", 
  "count_mean", 
  NA, 
  "Jul", 
  "count_se", 
  NA
)

names(jul) <- c(
  "month", 
  "type", 
  "mean", 
  "month.1", 
  "type.1", 
  "se"
)

aug <- data.frame(
  "Aug", 
  "count_mean", 
  NA, 
  "Aug", 
  "count_se", 
  NA
)

names(aug) <- c(
  "month", 
  "type", 
  "mean", 
  "month.1", 
  "type.1", 
  "se"
)

sep <- data.frame(
  "Sep", 
  "count_mean", 
  NA, 
  "Sep", 
  "count_se", 
  NA)

names(sep) <- c(
  "month", 
  "type", 
  "mean", 
  "month.1", 
  "type.1", 
  "se"
)

# Combine rows with df
data_current_stats <- rbind(
  data_current_stats, 
  jul, 
  aug, 
  sep
  ) %>%
  
  mutate(
    type = factor(type, levels = c(
      "count_mean", 
      "trees_mean", 
      "ratio_mean", 
      "count_se", 
      "trees_se", 
      "ratio_se"
    )),
    
    month = factor(month, levels = c(
      "Dec", "Jan", "Feb", 
      "Mar", "Apr", "May", 
      "Jun", "Jul", "Aug", 
      "Sep", "Oct", "Nov"
    )
  )
)

# Reverse × 40 multiplier
data_current_stats$true <- data_current_stats$mean/40 
```

```{r}
# Generate barplot
(mean_se_plot <- ggplot(
  
  data_current_stats, 
  aes(
    fill = type, 
    x    = month, 
    y    = mean
  )) +
  
  geom_bar(
    position = "dodge", 
    stat     = "identity"
  ) + 
  
  geom_errorbar(
    mapping = aes(
      col   = type, 
      x     = month, 
      ymax  = mean+se, 
      ymin  = mean-se
    ), 
    position = "dodge"
  ) + 
  
  facet_wrap(
    ~group, 
    scales = "free"
  ) +
  
  labs(
    x = "Month", 
    y = "Mean flying-fox abundance"
  )
 
  scale_colour_manual(
    name   = '', 
    guide  = "none", 
    values = c("#CACBE8","#7B7FC7","#1F2148")
  ) +
    
  scale_fill_manual(
    name   = '', 
    labels = c(
      "Mean flying-fox abundance", 
      "Mean trees occupied", 
      "Mean ratio of flying-fox to trees"), 
    values = c("#1F2148","#CACBE8","#7B7FC7")
  ) +
    
  scale_y_continuous(
    sec.axis = sec_axis(
      ~ ./40, 
      name = "Mean trees occupied and \nmean ratio of flying-fox to trees")
  )
   
  theme_minimal() + 
  
  theme(
    axis.line        = element_line(colour = "darkgrey"), 
    axis.text.x      = element_text(
      angle  = 0, 
      colour = "black", 
      hjust  = 0, 
      vjust  = 1
    ),
    axis.text.y      = element_text(
      angle  = 0, 
      colour = "black", 
      vjust  = 0.5
    ),
    axis.title.x     = element_text(vjust = -2), 
    axis.title.y     = element_text(
      margin = margin(r = 5), 
      vjust  = 5
    ), 
    legend.position  = "bottom", # "c(x, y)" or "none"
    legend.text      = element_text(size = 8),
    legend.title     = element_blank(),
    panel.background = element_rect(
      colour = NA, 
      fill   = "white"
    ), 
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(), 
        
    panel.border     = element_blank(),
    plot.margin      = margin(0.5, 0, 0, 0, "cm"), 
    
    # Add a plot label 
    plot.tag         = element_text(
      face  = "bold", 
      size  = 12, 
      vjust = -5
    ), 
    strip.background = element_blank()
  )
)
```

## Mean abundance per year

Stacked bar graph for 2012-23 with year on the x-axis and FF abundance on the y-axis (Fig 4), showing:

  1. Peak (maximum) FFs recorded for each year
  2. Mean FFs recorded for each year

```{r}
# Prepare the data
data <- read_excel(raw_data, sheet = "monitoring") %>%
  clean_names() %>%
  drop_na(ghff)%>%
  
  filter(
    include  == "Yes", 
    location == "Commonwealth Park"
  ) %>%
  
  mutate(ghff = if_else(
    ghff == "800-1000", 
    "900", 
    ghff)
  ) %>%
  
  # Replace ranges with mean
  mutate(ghff = if_else(
    ghff      == "200-250", 
    "225", 
    ghff)
  ) %>% 
  
  mutate(
    ghff = as.numeric(ghff),
    lrff = as.numeric(lrff),
    year = year(date)
  ) %>% 
  
  mutate(bats_total = ghff + lrff) %>%
  
  # Remove years prior to year 2000
  filter(year > 2000)

# Subset to peak abundances for each year
peak <- data %>% 
  group_by(year) %>%
  
  summarise(
    bats_mean = mean(bats_total), 
    bats_max  = max(bats_total)
  ) %>%
  
  mutate(bats_diff = bats_max-bats_mean) %>%
  
  pivot_longer(
    2:4, 
    names_to   = "type", 
    values_to  = "stat"
  ) %>%
  
  filter(type! = "bats_max")
```

```{r}
# Bar plot
(abun_years <- ggplot(peak, (aes(year, stat, fill = type))) +
  geom_bar(stat = "identity") + 
  
  labs(
    x = "Year", 
    y = "Flying-fox abundance"
  ) +
  
  scale_fill_manual(
    labels = c("Peak", "Mean"), 
    name   = "", 
    values = c("#1F2148","#CACBE8")
  ) +
  
  scale_x_continuous(
    breaks = seq(2011, REPORTING_PERIOD, 1)) + 
  scale_y_continuous(
    breaks = seq(0, 10000, 2000))
  
  theme_minimal() +
  
  theme(
    axis.line        = element_line(colour = "darkgrey"), 
    axis.text.x      = element_text(angle = 0, hjust = 0, vjust = 0.5),
    axis.title.y     = element_text(
      angle  = 0, 
      hjust  = 0, 
      margin = margin(r = 5), 
      vjust  = 0.5
    ),
    
    legend.position  = "bottom", # "c(x, y)" or "none"
    legend.text      = element_text(size = 8),
    legend.title     = element_blank(), 
    panel.background = element_rect(fill = "white", colour = NA), 
    panel.border     = element_blank(),
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(), 
    plot.margin      = margin(0.5, 0, 0, 0, "cm"),
    
    # Add a plot label 
    plot.tag         = element_text(size = 12, face = "bold", vjust = -5),
    plot.title       = element_text(
      face   = "bold", 
      margin = margin(10, 0, 10, 0), 
      size   = 15
    ), 
    strip.background = element_blank()
  ) 
)

# Display the plot
print(abun_years)
```

```{r, include = FALSE}
# Save plot as a jpeg
jpeg(
  file   = "output/fig 4 abundance per year.jpeg", 
  height = 2500, 
  width  = 6000, 
  units  = "px", 
  res    = 800
)

print(abun_years)
dev.off()
```

## Abundance and temperature

Here we overlay a line graph of FF abundance since 2012 with maximum and minimum temperature (Fig 5) from the [Australian Bureau of Meteorology](http://www.bom.gov.au/climate/data/index.shtml?bookmark = 136) (navigate to `ACT` > `Past weather` > `Data and graphs` > `Text search` > `Temperature` > `Maximum temperature` or `Minimum temperature` > weather station `70351`). 

```{r}
# Read in weather data
weather <- read_excel(raw_data, sheet = "weather") %>%
  clean_names() %>% 
  filter(year > 2011) %>%
  
  rename(
    max = "max_temperature_degree_c", 
    min = "min_temperature_degree_c"
  ) %>%
  
  mutate(date = paste(
    year, 
    month, 
    day, 
    sep = "/"
  )) %>%
  
  mutate(date = as.Date(date, format = c("%Y/%m/%d")))

# Pivot to long format
weather_long <- pivot_longer(
  weather,
  5:6, 
  names_to  = "type", 
  values_to = "temperature"
)
```

```{r}
# Generate ribbon and line plot
(survey_weather_plot <- ggplot() +
  geom_ribbon(
    data   = weather, 
    aes(
      as.Date(date), 
      ymin = min, 
      ymax = max
    ), 
    alpha  = 0.5, 
    fill   = "#CACBE8"
  ) +
  
  geom_line(
    data = data, 
    aes(
      as.Date(date), 
      bats_total/200), 
    col  = "#1F2148", 
    size = 0.6
  ) +
  
  scale_x_date(
    name        = "Year", 
    date_labels = "%Y", 
    date_breaks = "2 years"
  ) +
  
  scale_y_continuous(
    name     = "Daily temperature (°C)", 
    sec.axis = sec_axis(
      ~ .*200, 
      breaks = seq(0, 10000, 2000),
      name   = "Flying-fox abundance")
  )
  
  theme_minimal() +
  theme(
    axis.line        = element_line(colour = "darkgrey"), 
    axis.text.x      = element_text(hjust = 0, vjust = 1),
    axis.text.y      = element_text(hjust = 0, vjust = 0.5), 
    axis.title.x     = element_text(vjust = -2), 
    axis.title.y     = element_text(vjust = 5, margin = margin(r = 5)),
    legend.position  = "bottom", # "c(x, y)" or "none"
    legend.text      = element_text(size = 8),
    legend.title     = element_blank(), 
    panel.background = element_rect(fill = "white", colour = NA), 
    panel.border     = element_blank(),
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(), 
    plot.margin      = margin(t = 0.5, r = 0, b = 0, l = 0, "cm"), 
    
    # Add a plot label 
    plot.tag         = element_text(size = 12, face = "bold", vjust = -5), 
    strip.background = element_blank()
  ) 
)
```

```{r, include = FALSE}
# Save plot as a jpeg
jpeg(
  file   = "output/fig 5 abundance and temperature.jpeg", 
  height = 2500, 
  width  = 6000, 
  units  = "px", 
  res    = 800
)

print(survey_weather_plot)
dev.off()
```

## Density maps

Here we map the density of FFs in each tree across the camp (Fig 6). `surveys_wide` is from the `surveys` table in the database, and `trees` is from the `trees` table. 

Because we didn't do any surveys in June and July, but want them to appear in our figure, *you will need to add dummy surveys for these months* into the `surveys` dataframe. You can do this by copying the row for Aug 22, 2020 (where all the trees have 0 bats) several times for each missing month per year, and changing the date to one that occurs in each missing month (e.g., Jun 1, 2020 for June). 

  1. Convert tree columns from wide format (one per column) to long format (tree identities listed in one column).

```{r}
# Read in data
surveys_wide <- read_excel(raw_data, sheet = "surveys") %>%
  subset(SurveyID! = "N/A")

# Pivot the table to wide format
surveys <- melt(
  surveys_wide, 
  measure.vars  = c(30:203), 
  variable.name = "tree", 
  value.name    = "bats"
)
```

  2. Merge surveys with coordinates for each tree
  3. Create `month` and `year` variables

```{r, results = 'hide', warning = FALSE, message = FALSE}
# Read in the tree-by-tree data
trees <- read_excel(raw_data, sheet = "trees") %>%
  clean_names() %>%
  mutate(tree = tree_id)

# Join survey and tree data
surveys_trees <- left_join(surveys, trees, by = "tree") %>%
  clean_names() %>%
  subset(bats! = 999) %>%
  mutate(
    year  = format(date, "%Y"),
    month = format(date, "%b"), 
    dates = format(date, "%d %b %y")
  )
```

 4. Get base layer from Google Maps

```{r, results = 'hide', warning = FALSE, message = FALSE}
map <- get_map(
  location = c(lon = 149.131749, lat = -35.289492), 
  zoom     = 19, 
  source   = "google", 
  maptype  = "roadmap", 
  crop     = FALSE
)
```

  5. Order months
  6. Categorise number of bats
  7. Subset the data for 2019–23

```{r}
# Prepare the survey and tree data
data <- surveys_trees %>%
  
  # Format date column
  mutate(date = as.Date(date, format = c("%d/%m/%Y"))) %>%
  
  # Select only dates during the current reporting period
  subset(date > START & date < END) %>%
  
  mutate(
    month = factor(month, levels = c(
      "Dec", "Jan", "Feb", 
      "Mar", "Apr", "May", 
      "Jun", "Jul", "Aug", 
      "Sep", "Oct", "Nov"
    )), 
    
    foxes    = cut(
      as.numeric(bats), 
      breaks = c(-Inf, 50, 100, 200, 400, Inf), 
      labels = c(
        "0-50", 
        "50-100", 
        "100-200", 
        "200-400", 
        ">400"
      ))) %>%
  
  mutate(foxes = factor(foxes, levels = c(
    ">400", 
    "100-200", 
    "200-400", 
    "50-100", 
    "0-50"
  )))
```

  6. Map the number of `Bats` recorded per `Month`

```{r}
# Plot density map
density_map <- ggmap(map) + 
  geom_point(
    data, 
    mapping = aes(x = longitude, y = latitude), 
    alpha   = 0.2, 
    col     = "darkgreen", 
    shape   = 8, 
    size    = 1
  ) +
  
  geom_point(
    data, 
    size    = 1, 
    mapping = aes(
      alpha = as.numeric(bats), 
      col   = as.numeric(bats), 
      x     = longitude, 
      y     = latitude
    )) +
  
  facet_wrap(~month, ncol = 3) +
  
  guides(
    alpha     = guide_legend(
      title   = "Number of \nflying-foxes\nrecorded", 
      reverse = TRUE
    )
    col       = guide_legend(
      title   = "Number of \nflying-foxes\nrecorded", 
      reverse = TRUE
    )) +
  
  labs(x = "", y = "")
  
  scale_colour_gradient2(
    low      = 0, 
    midpoint = 10, 
    mid      = "yellow", 
    high     = "red"
  ) +
    
  
  theme(
    axis.line        = element_line(colour = "darkgrey"), 
    axis.text.x      = element_blank(), 
    axis.text.y      = element_blank(),
    axis.ticks.x     = element_blank(),
    axis.ticks.y     = element_blank(),
    axis.title.x     = element_text(vjust = -2), 
    axis.title.y     = element_text(vjust = 5, margin = margin(r = 5)), 
    legend.key       = element_blank(), 
    legend.text      = element_text(size = 8),
    legend.title     = element_blank(), 
    panel.grid       = element_blank(),
    panel.background = element_rect(fill = "white", colour = NA), 
    plot.margin      = margin(t = -10, r = 4, b = 5, l = 5), 
    
    # Add a plot label 
    plot.tag         = element_text(size = 12, face = "bold", vjust = -5), 
    strip.background = element_rect(fill = "#1F2148"),
    strip.text       = element_text(colour = "white")
)
```

```{r, include = FALSE}
# Save the plot as a jpeg file
ggsave(
  filename = "output/fig 6 tree density maps.jpeg", 
  plot     = density_map, 
  height   = 3500, 
  width    = 4000, 
  units    = "px", 
  dpi      = 800
)
```

## Camp occupation

Here we plot the dates that flying-foxes occupied the camp each year. Because the flying-foxes never vacated the camp in 2014, we entered back-to-back dates to enable plotting. 

```{r}
# Read in dates of camp occupation
occ <- read_excel(raw_data, sheet = "occupation") %>%
  clean_names() %>%
  
  # Exclude years with missing dates
  filter(!is.na(arrival) & !is.na(departure)) %>% 
  mutate(across(c(
    peak_date, 
    departure, 
    arrival, 
    year_start, 
    year_end), 
  as.Date),
         
  # Extract month and day and apply a single year
  arr_date  = as.Date(paste("2012", format(arrival,   "%m-%d"), sep = "-")),
  dep_date  = as.Date(paste("2012", format(departure, "%m-%d"), sep = "-")),
  peak_date = as.Date(paste("2012", format(peak_date, "%m-%d"), sep = "-")),
  
  # Treat year as a factor
  year = factor(year),
  
  # Make another year factor for a secondary y-axis
  year_sec = as.numeric(as.character(year)))
```

```{r}
# Generate plot
(occ_plot <- ggplot(occ) +
  geom_segment(
    aes(
      y       = year_sec, 
      yend    = year_sec, 
      x       = as.Date(format(year_start, "2012-%m-%d")),
      xend    = as.Date(format(  dep_date, "2012-%m-%d")),
      color   = year
    ), 
    linewidth = 2
  ) +
  
  geom_segment(
    aes(
    color     = year, 
    x         = as.Date(format(arr_date, "2012-%m-%d")),
    xend      = as.Date(format(year_end, "2012-%m-%d")), 
    y         = year_sec, yend = year_sec
    ), 
    linewidth = 2
  ) +
  
  geom_point(
    aes(
      fill = year, 
      x = as.Date(format(peak_date, "2012-%m-%d")), 
      y = year_sec 
    ), 
    alpha  = 0.6, 
    color  = "white", 
    shape  = 21, 
    size   = 5, 
    stroke = 1.2
  ) +
 
   # Add departure date labels after the bar
  geom_text(
    aes(
      label = format(dep_date, "%d %b"), 
      x     = as.Date(format(dep_date, "2012-%m-%d")) + 5, 
      y     = year_sec
    ),
    color   = "grey50", 
    hjust   = 0, 
    size    = 2.5
  ) +
 
   # Add arrival date labels before the bar
  geom_text(
    aes(
      label = format(arr_date, "%d %b"), 
      x     = as.Date(format(arr_date, "2012-%m-%d")) - 5, 
      y     = year_sec
    ),
    color   = "grey50", 
    hjust   = 1, 
    size    = 2.5
  ) +
 
   scale_x_date(
     date_labels = "%b", 
     date_breaks = "1 month",
     limits      = c(
       as.Date("2012-01-01"), 
       as.Date("2012-12-31")
  )) +
  
  labs(x = "Month") + 
  
  scale_color_viridis_d() + 
  scale_fill_viridis_d()  +
  
  scale_y_continuous(
    name     = "Year", 
    breaks   = occ$year_sec, 
    labels   = occ$year, 
    sec.axis = sec_axis(
      ~., 
      breaks = occ$year_sec, 
      labels = occ$peak_abundance, 
      name   = "Peak flying-fox abundance"
  )) +
  
  theme_minimal() +
  
  theme(
    axis.line          = element_line(colour = "darkgrey"), 
    axis.text.x        = element_text(angle  = 0, hjust = 1), 
    axis.text.y        = element_text(angle  = 0, hjust = 1), 
    axis.title.x       = element_text(vjust  = -2), 
    axis.title.y       = element_text(margin = margin(r = 10)), 
    axis.title.y.right = element_text(margin = margin(l = 10)), 
    legend.position    = "none", # "c(x, y)" or "none"
    legend.text        = element_text(size = 8),
    legend.title       = element_blank(), 
    panel.background   = element_rect(fill = "white", colour = NA), 
    panel.grid         = element_blank(),
    plot.margin        = margin(t = 0, r = 0, b = 0, l = 0), 
    
    # Add a plot label 
    plot.tag           = element_text(size = 12, face = "bold", vjust = -5), 
    strip.background   = element_blank()
  )
)
```

```{r, include = FALSE}
# Save the plot as a jpeg file
ggsave(
  filename = "output/fig 7 camp occupation barplot.jpeg",
  plot     = occ_plot, 
  height   = 3500, 
  width    = 6000, 
  units    = "px", 
  dpi      = 800
)
```

# **Session information**

```{r, eval = TRUE}
# Display R version, OS, and loaded packages
sessionInfo()
```